{"ast":null,"code":"import _slicedToArray from\"/Users/thetrung/Downloads/wtg-backendv2-master@42dd489862c/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useRef,useEffect,useCallback}from'react';import{useHistory}from'react-router-dom';import{useQuery}from'@apollo/react-hooks';import{select,hierarchy,tree,linkHorizontal,zoom,zoomTransform}from'd3';import{getNodeById,treeFormatter,getNodeColorByEntityType}from'./treeEditorHelper';import{GET_TREE_BY_ID}from'../../services/graphQL/editorApiHelper';import{renderNode,renderLabel,renderPath,renderDescription,renderDescriptionNode,removeDuplicateDOM,renderTactics,renderTacticsNode,transformWhenZoom,expandLabelCoverTactics,hideDescriptionAndTacticsWhenZoom,hideEmptyDescriptionTactics}from'./d3Helper';import useResizeObserver from'./treeResizeObserver';import{PreviewBar}from'../../components/preview-bar/previewBar';import Menu from'../../components/editor-dropdown-menu/dropdownMenu';import DeleteAlert from'../../components/delete-node-alert/deleteAlert';import ErrorLayout from'../../components/error-layout/errorLayout';import LoadingLayout from'../../components/loading-layout/loadingLayout';import ReturnButton from'../../components/return-button/returnButton';import'./treeEditor.scss';function TreeEditor(){var history=useHistory();var treeId=history.location.pathname.substring(6);var _useQuery=useQuery(GET_TREE_BY_ID,{variables:{id:treeId},pollInterval:10000}),data=_useQuery.data,error=_useQuery.error,refetch=_useQuery.refetch;// Handle D3 Graph Generation & MouseControl Logic\nvar _useState=useState({k:0.5,x:400,y:300}),_useState2=_slicedToArray(_useState,2),currentZoomState=_useState2[0],setCurrentZoomState=_useState2[1];var svgRef=useRef();var wrapperRef=useRef();var dimensions=useResizeObserver(wrapperRef);var zoomBehavior=zoom().scaleExtent([0.1,1]).on('zoom',handleZoom);function handleZoom(){if(isDeleteDialogOpen===false){var zoomState=zoomTransform(svgRef.current);setCurrentZoomState(zoomState);setIsDialogOpen(false);}}// Handles Node Manipulation Logic\nvar _useState3=useState({show:false,x:0,y:0}),_useState4=_slicedToArray(_useState3,2),toolTip=_useState4[0],setToolTip=_useState4[1];var _useState5=useState({}),_useState6=_slicedToArray(_useState5,2),currentPreviewNode=_useState6[0],setCurrentPreviewNode=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),isDialogOpen=_useState8[0],setIsDialogOpen=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),isPreviewBarOpen=_useState10[0],setIsPreviewBarOpen=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),isDeleteDialogOpen=_useState12[0],setIsDeleteDialogOpen=_useState12[1];var _useState13=useState('viewing'),_useState14=_slicedToArray(_useState13,2),viewMode=_useState14[0],updateViewMode=_useState14[1];var _useState15=useState(''),_useState16=_slicedToArray(_useState15,2),formattedTree=_useState16[0],setFormattedTree=_useState16[1];var toggleIsDialogOpen=useCallback(function(){if(!isPreviewBarOpen)setIsDialogOpen(!isDialogOpen);},[isDialogOpen,isPreviewBarOpen]);var toggleIsPreviewBarOpen=useCallback(function(){return setIsPreviewBarOpen(!isPreviewBarOpen);},[isPreviewBarOpen]);var toggleDeleteDialog=useCallback(function(){return setIsDeleteDialogOpen(!isDeleteDialogOpen);},[isDeleteDialogOpen]);var resetPreviewBarAndDialogOpen=useCallback(function(){setIsPreviewBarOpen(false);setIsDialogOpen(false);updateViewMode('viewing');},[]);function setPreviewMode(view){updateViewMode(view);}function updateCurrentNode(node){setCurrentPreviewNode(node);}var refetchTree=function refetchTree(){return refetch();};useEffect(function(){function toggleToolTip(x,y){setToolTip({show:isDialogOpen,x:x,y:y});}function triggerMenu(node){if(!isDeleteDialogOpen){setCurrentPreviewNode(getNodeById(node.data.id,data.getTreeById));toggleIsDialogOpen();toggleToolTip(node.y+currentZoomState.x+50,node.x+currentZoomState.y+200,true);}}if(data){if(!dimensions)return;setFormattedTree(treeFormatter(data.getTreeById));var svg=select(svgRef.current);var root=hierarchy(formattedTree);root.x=currentZoomState.x;root.y=currentZoomState.y;var h=275;var w=600;if(currentZoomState.k<0.6){h=100;w=300;}var treeLayout=tree().nodeSize([h,w]).separation(function(a,b){return a.parent===b.parent?1:1.25;});treeLayout(root);if(currentZoomState){var linkGenerator=linkHorizontal().x(function(node){return node.y+currentZoomState.x+180;}).y(function(node){return node.x+currentZoomState.y+200;});renderPath(svg,root,linkGenerator,currentZoomState.k);renderNode(svg,root,function(node){return node.y+currentZoomState.x+50;},function(node){return node.x+currentZoomState.y+160;},function(node){return getNodeColorByEntityType(node.data.entityType);},currentZoomState.k);renderDescriptionNode(svg,root,function(node){return node.y+currentZoomState.x+50;},function(node){return node.x+currentZoomState.y+240;},function(node){return getNodeColorByEntityType(node.data.entityType);},currentZoomState.k);renderLabel(svg,root,function(node){return node.y+currentZoomState.x+50;},function(node){return node.x+currentZoomState.y+160;},currentZoomState.k,function(node){return\"[\".concat(node.data.referenceId,\"] \").concat(node.data.name);},function(node){return getNodeColorByEntityType(node.data.entityType);}).on('click',function(node){triggerMenu(node);});renderDescription(svg,root,function(node){return node.y+currentZoomState.x+50;},function(node){return node.x+currentZoomState.y+240;},currentZoomState.k,function(node){return node.data.description;}).on('click',function(node){triggerMenu(node);});renderTacticsNode(svg,root,function(node){return node.y+currentZoomState.x+230;},function(node){return node.x+currentZoomState.y+240;},currentZoomState.k,function(node){return node.data.tactic;});renderTactics(svg,root,function(node){return node.y+currentZoomState.x+230;},function(node){return node.x+currentZoomState.y+240;},currentZoomState.k,function(node){return node.data.tactic;}).on('click',function(node){triggerMenu(node);});if(currentZoomState.k<0.6){hideDescriptionAndTacticsWhenZoom(svg);}svg.selectAll('.dropdownHolder').raise();svg.selectAll('.deleteDialogHolder').raise();}removeDuplicateDOM();expandLabelCoverTactics('tacticsText','node');expandLabelCoverTactics('tacticsText','label');hideEmptyDescriptionTactics();svg.call(zoomBehavior);transformWhenZoom(svg,currentZoomState);}},[currentZoomState,dimensions,zoomBehavior,currentPreviewNode,toggleIsDialogOpen,formattedTree,isDeleteDialogOpen,data,isDialogOpen]);if(data){return/*#__PURE__*/React.createElement(\"div\",{ref:wrapperRef,className:\"treeEditor\"},/*#__PURE__*/React.createElement(ReturnButton,null),/*#__PURE__*/React.createElement(\"dialog\",{open:isPreviewBarOpen},currentPreviewNode.id?/*#__PURE__*/React.createElement(PreviewBar,{rootNodeId:formattedTree.id,nodeData:currentPreviewNode,refreshView:refetchTree,handleNodeAttributesUpdate:updateCurrentNode,closeForm:toggleIsPreviewBarOpen,chooseMode:viewMode,closePreview:resetPreviewBarAndDialogOpen}):null),/*#__PURE__*/React.createElement(\"svg\",{ref:svgRef,className:\"treeEditor-canvas\"},/*#__PURE__*/React.createElement(\"foreignObject\",{width:\"200\",height:\"122\",x:toolTip.x+50,y:toolTip.y,className:\"dropdownHolder\",transform:\"translate(\".concat(currentZoomState.x,\", \").concat(currentZoomState.y,\") scale(\").concat(currentZoomState.k,\")\"),style:{visibility:isDialogOpen?'visible':'hidden'}},/*#__PURE__*/React.createElement(Menu,{togglePreviewBar:toggleIsPreviewBarOpen,closeForm:toggleIsDialogOpen,togglePreviewMode:setPreviewMode,toggleDeleteDialog:toggleDeleteDialog})),/*#__PURE__*/React.createElement(\"foreignObject\",{width:\"300\",height:\"125\",className:\"deleteDialogHolder\",x:toolTip.x,y:toolTip.y,transform:\"translate(\".concat(currentZoomState.x,\", \").concat(currentZoomState.y,\")scale(\").concat(currentZoomState.k,\")\"),style:{visibility:isDeleteDialogOpen?'visible':'hidden'}},/*#__PURE__*/React.createElement(DeleteAlert,{nodeData:currentPreviewNode,toggleDeleteDialog:toggleDeleteDialog,refreshView:refetch}))));}else if(error){return/*#__PURE__*/React.createElement(\"div\",{ref:wrapperRef},/*#__PURE__*/React.createElement(ErrorLayout,{isStandAlonePage:true}));}else{return/*#__PURE__*/React.createElement(\"div\",{ref:wrapperRef},/*#__PURE__*/React.createElement(LoadingLayout,{isStandAlonePage:true}));}}export default TreeEditor;","map":{"version":3,"sources":["/Users/thetrung/Downloads/wtg-backendv2-master@42dd489862c/client/src/pages/tree-editor/treeEditor.jsx"],"names":["React","useState","useRef","useEffect","useCallback","useHistory","useQuery","select","hierarchy","tree","linkHorizontal","zoom","zoomTransform","getNodeById","treeFormatter","getNodeColorByEntityType","GET_TREE_BY_ID","renderNode","renderLabel","renderPath","renderDescription","renderDescriptionNode","removeDuplicateDOM","renderTactics","renderTacticsNode","transformWhenZoom","expandLabelCoverTactics","hideDescriptionAndTacticsWhenZoom","hideEmptyDescriptionTactics","useResizeObserver","PreviewBar","Menu","DeleteAlert","ErrorLayout","LoadingLayout","ReturnButton","TreeEditor","history","treeId","location","pathname","substring","variables","id","pollInterval","data","error","refetch","k","x","y","currentZoomState","setCurrentZoomState","svgRef","wrapperRef","dimensions","zoomBehavior","scaleExtent","on","handleZoom","isDeleteDialogOpen","zoomState","current","setIsDialogOpen","show","toolTip","setToolTip","currentPreviewNode","setCurrentPreviewNode","isDialogOpen","isPreviewBarOpen","setIsPreviewBarOpen","setIsDeleteDialogOpen","viewMode","updateViewMode","formattedTree","setFormattedTree","toggleIsDialogOpen","toggleIsPreviewBarOpen","toggleDeleteDialog","resetPreviewBarAndDialogOpen","setPreviewMode","view","updateCurrentNode","node","refetchTree","toggleToolTip","triggerMenu","getTreeById","svg","root","h","w","treeLayout","nodeSize","separation","a","b","parent","linkGenerator","entityType","referenceId","name","description","tactic","selectAll","raise","call","visibility"],"mappings":"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","sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport { useHistory } from 'react-router-dom';\nimport { useQuery } from '@apollo/react-hooks';\nimport { select, hierarchy, tree, linkHorizontal, zoom, zoomTransform } from 'd3';\nimport { getNodeById, treeFormatter, getNodeColorByEntityType } from './treeEditorHelper';\nimport { GET_TREE_BY_ID } from '../../services/graphQL/editorApiHelper';\nimport {\n    renderNode,\n    renderLabel,\n    renderPath,\n    renderDescription,\n    renderDescriptionNode,\n    removeDuplicateDOM,\n    renderTactics,\n    renderTacticsNode,\n    transformWhenZoom,\n    expandLabelCoverTactics,\n    hideDescriptionAndTacticsWhenZoom,\n    hideEmptyDescriptionTactics,\n} from './d3Helper';\nimport useResizeObserver from './treeResizeObserver';\nimport { PreviewBar } from '../../components/preview-bar/previewBar';\nimport Menu from '../../components/editor-dropdown-menu/dropdownMenu';\nimport DeleteAlert from '../../components/delete-node-alert/deleteAlert';\nimport ErrorLayout from '../../components/error-layout/errorLayout';\nimport LoadingLayout from '../../components/loading-layout/loadingLayout';\nimport ReturnButton from '../../components/return-button/returnButton';\nimport './treeEditor.scss';\n\nfunction TreeEditor() {\n    const history = useHistory();\n    const treeId = history.location.pathname.substring(6);\n    const { data, error, refetch } = useQuery(GET_TREE_BY_ID, {\n        variables: {\n            id: treeId,\n        },\n        pollInterval: 10000,\n    });\n\n    // Handle D3 Graph Generation & MouseControl Logic\n    const [currentZoomState, setCurrentZoomState] = useState({\n        k: 0.5,\n        x: 400,\n        y: 300,\n    });\n    const svgRef = useRef();\n    const wrapperRef = useRef();\n    const dimensions = useResizeObserver(wrapperRef);\n    const zoomBehavior = zoom().scaleExtent([0.1, 1]).on('zoom', handleZoom);\n\n    function handleZoom() {\n        if (isDeleteDialogOpen === false) {\n            const zoomState = zoomTransform(svgRef.current);\n            setCurrentZoomState(zoomState);\n            setIsDialogOpen(false);\n        }\n    }\n    // Handles Node Manipulation Logic\n    const [toolTip, setToolTip] = useState({ show: false, x: 0, y: 0 });\n    const [currentPreviewNode, setCurrentPreviewNode] = useState({});\n    const [isDialogOpen, setIsDialogOpen] = useState(false);\n    const [isPreviewBarOpen, setIsPreviewBarOpen] = useState(false);\n    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n    const [viewMode, updateViewMode] = useState('viewing');\n    const [formattedTree, setFormattedTree] = useState('');\n    const toggleIsDialogOpen = useCallback(() => {\n        if (!isPreviewBarOpen) setIsDialogOpen(!isDialogOpen);\n    }, [isDialogOpen, isPreviewBarOpen]);\n    const toggleIsPreviewBarOpen = useCallback(() => setIsPreviewBarOpen(!isPreviewBarOpen), [isPreviewBarOpen]);\n    const toggleDeleteDialog = useCallback(() => setIsDeleteDialogOpen(!isDeleteDialogOpen), [isDeleteDialogOpen]);\n    const resetPreviewBarAndDialogOpen = useCallback(() => {\n        setIsPreviewBarOpen(false);\n        setIsDialogOpen(false);\n        updateViewMode('viewing');\n    }, []);\n\n    function setPreviewMode(view) {\n        updateViewMode(view);\n    }\n    function updateCurrentNode(node) {\n        setCurrentPreviewNode(node);\n    }\n\n    const refetchTree = () => refetch();\n\n    useEffect(() => {\n        function toggleToolTip(x, y) {\n            setToolTip({ show: isDialogOpen, x: x, y: y });\n        }\n\n        function triggerMenu(node) {\n            if (!isDeleteDialogOpen) {\n                setCurrentPreviewNode(getNodeById(node.data.id, data.getTreeById));\n                toggleIsDialogOpen();\n                toggleToolTip(node.y + currentZoomState.x + 50, node.x + currentZoomState.y + 200, true);\n            }\n        }\n        if (data) {\n            if (!dimensions) return;\n            setFormattedTree(treeFormatter(data.getTreeById));\n            const svg = select(svgRef.current);\n            const root = hierarchy(formattedTree);\n            root.x = currentZoomState.x;\n            root.y = currentZoomState.y;\n            var h = 275;\n            var w = 600;\n            if (currentZoomState.k < 0.6) {\n                h = 100;\n                w = 300;\n            }\n            const treeLayout = tree()\n                .nodeSize([h, w])\n                .separation(function (a, b) {\n                    return a.parent === b.parent ? 1 : 1.25;\n                });\n            treeLayout(root);\n\n            if (currentZoomState) {\n                const linkGenerator = linkHorizontal()\n                    .x(node => node.y + currentZoomState.x + 180)\n                    .y(node => node.x + currentZoomState.y + 200);\n                renderPath(svg, root, linkGenerator, currentZoomState.k);\n                renderNode(\n                    svg,\n                    root,\n                    node => node.y + currentZoomState.x + 50,\n                    node => node.x + currentZoomState.y + 160,\n                    node => getNodeColorByEntityType(node.data.entityType),\n                    currentZoomState.k\n                );\n\n                renderDescriptionNode(\n                    svg,\n                    root,\n                    node => node.y + currentZoomState.x + 50,\n                    node => node.x + currentZoomState.y + 240,\n                    node => getNodeColorByEntityType(node.data.entityType),\n                    currentZoomState.k\n                );\n\n                renderLabel(\n                    svg,\n                    root,\n                    node => node.y + currentZoomState.x + 50,\n                    node => node.x + currentZoomState.y + 160,\n                    currentZoomState.k,\n                    node => {\n                        return `[${node.data.referenceId}] ${node.data.name}`;\n                    },\n                    node => getNodeColorByEntityType(node.data.entityType)\n                ).on('click', node => {\n                    triggerMenu(node);\n                });\n\n                renderDescription(\n                    svg,\n                    root,\n                    node => node.y + currentZoomState.x + 50,\n                    node => node.x + currentZoomState.y + 240,\n                    currentZoomState.k,\n                    node => node.data.description\n                ).on('click', node => {\n                    triggerMenu(node);\n                });\n                renderTacticsNode(\n                    svg,\n                    root,\n                    node => node.y + currentZoomState.x + 230,\n                    node => node.x + currentZoomState.y + 240,\n                    currentZoomState.k,\n                    node => node.data.tactic\n                );\n                renderTactics(\n                    svg,\n                    root,\n                    node => node.y + currentZoomState.x + 230,\n                    node => node.x + currentZoomState.y + 240,\n                    currentZoomState.k,\n                    node => node.data.tactic\n                ).on('click', node => {\n                    triggerMenu(node);\n                });\n                if (currentZoomState.k < 0.6) {\n                    hideDescriptionAndTacticsWhenZoom(svg);\n                }\n                svg.selectAll('.dropdownHolder').raise();\n                svg.selectAll('.deleteDialogHolder').raise();\n            }\n            removeDuplicateDOM();\n            expandLabelCoverTactics('tacticsText', 'node');\n            expandLabelCoverTactics('tacticsText', 'label');\n            hideEmptyDescriptionTactics();\n            svg.call(zoomBehavior);\n            transformWhenZoom(svg, currentZoomState);\n        }\n    }, [\n        currentZoomState,\n        dimensions,\n        zoomBehavior,\n        currentPreviewNode,\n        toggleIsDialogOpen,\n        formattedTree,\n        isDeleteDialogOpen,\n        data,\n        isDialogOpen,\n    ]);\n    if (data) {\n        return (\n            <div ref={wrapperRef} className='treeEditor'>\n                <ReturnButton />\n                <dialog open={isPreviewBarOpen}>\n                    {currentPreviewNode.id ? (\n                        <PreviewBar\n                            rootNodeId={formattedTree.id}\n                            nodeData={currentPreviewNode}\n                            refreshView={refetchTree}\n                            handleNodeAttributesUpdate={updateCurrentNode}\n                            closeForm={toggleIsPreviewBarOpen}\n                            chooseMode={viewMode}\n                            closePreview={resetPreviewBarAndDialogOpen}\n                        />\n                    ) : null}\n                </dialog>\n                <svg ref={svgRef} className='treeEditor-canvas'>\n                    <foreignObject\n                        width='200'\n                        height='122'\n                        x={toolTip.x + 50}\n                        y={toolTip.y}\n                        className='dropdownHolder'\n                        transform={`translate(${currentZoomState.x}, ${currentZoomState.y}) scale(${currentZoomState.k})`}\n                        style={{ visibility: isDialogOpen ? 'visible' : 'hidden' }}\n                    >\n                        <Menu\n                            togglePreviewBar={toggleIsPreviewBarOpen}\n                            closeForm={toggleIsDialogOpen}\n                            togglePreviewMode={setPreviewMode}\n                            toggleDeleteDialog={toggleDeleteDialog}\n                        />\n                    </foreignObject>\n                    <foreignObject\n                        width='300'\n                        height='125'\n                        className='deleteDialogHolder'\n                        x={toolTip.x}\n                        y={toolTip.y}\n                        transform={`translate(${currentZoomState.x}, ${currentZoomState.y})scale(${currentZoomState.k})`}\n                        style={{ visibility: isDeleteDialogOpen ? 'visible' : 'hidden' }}\n                    >\n                        <DeleteAlert\n                            nodeData={currentPreviewNode}\n                            toggleDeleteDialog={toggleDeleteDialog}\n                            refreshView={refetch}\n                        />\n                    </foreignObject>\n                </svg>\n            </div>\n        );\n    } else if (error) {\n        return (\n            <div ref={wrapperRef}>\n                <ErrorLayout isStandAlonePage={true} />\n            </div>\n        );\n    } else {\n        return (\n            <div ref={wrapperRef}>\n                <LoadingLayout isStandAlonePage={true} />\n            </div>\n        );\n    }\n}\n\nexport default TreeEditor;\n"]},"metadata":{},"sourceType":"module"}